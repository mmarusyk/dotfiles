#!/usr/bin/env bash

set -euo pipefail

ROOT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")/.." && pwd)"

# Load shared utils
for f in "$ROOT_DIR/lib/utils/"*.sh; do source "$f"; done
source "$ROOT_DIR/lib/executor.sh"

# Flags
DRY_RUN=false
VERBOSE=false
PROFILE=""
MANIFESTS=()

usage() {
  echo "Usage: install [options] [manifest...]"
  echo ""
  echo "Install system dependencies and dotfiles"
  echo ""
  echo "Options:"
  echo "  -p, --profile <name>  Install a specific profile (default: default)"
  echo "  -d, --dry-run         Show what would be executed without running"
  echo "  -v, --verbose         Enable verbose output"
  echo "  -h, --help            Show this help"
  echo ""
  echo "Arguments:"
  echo "  manifest              One or more specific manifests to install"
  echo ""
  echo "Examples:"
  echo "  install                       Install default profile"
  echo "  install --profile default     Install default development profile"
  echo "  install docker nodejs         Install specific manifests"
  echo "  install git zsh --verbose     Install git and zsh with verbose output"
  echo "  install --dry-run --verbose   Preview installation steps"
}

while [[ $# -gt 0 ]]; do
  case "$1" in
    -p|--profile)
      PROFILE="$2"
      shift 2
      ;;
    -d|--dry-run) DRY_RUN=true; shift ;;
    -v|--verbose) VERBOSE=true; shift ;;
    -h|--help) usage; exit 0 ;;
    -*)
      echo "‚ùå Unknown option: $1"
      usage
      exit 1
      ;;
    *)
      # Positional argument - treat as manifest name
      MANIFESTS+=("$1")
      shift
      ;;
  esac
done

detect_os
require_dependencies yq

# Determine what to install
if [[ ${#MANIFESTS[@]} -gt 0 ]]; then
  # Install specific manifests
  log_info "üöÄ Installing ${#MANIFESTS[@]} manifest(s) for $DETECTED_OS..."
  for manifest in "${MANIFESTS[@]}"; do
    run_manifest "$manifest" "$DETECTED_OS" "install" "$DRY_RUN" "$VERBOSE"
  done
  log_success "‚úÖ All manifests installed successfully!"
else
  # Install profile (default if not specified)
  PROFILE="${PROFILE:-default}"
  log_info "üöÄ Installing profile '$PROFILE' for $DETECTED_OS..."
  run_manifest "profiles/$PROFILE" "$DETECTED_OS" "install" "$DRY_RUN" "$VERBOSE"
  log_success "‚úÖ Profile '$PROFILE' installed successfully!"
fi
